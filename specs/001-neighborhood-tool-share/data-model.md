# Data Model: Abbington Neighborhood Tool Share

**Date**: 2025-10-22 (Updated for Supabase)
**Database**: Supabase (PostgreSQL 15+)

## Entities

### users

Represents a member of the Abbington neighborhood who has signed up for the tool share.

**Schema** (Supabase table):
```sql
CREATE TABLE users (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  facebook_id TEXT UNIQUE NOT NULL,
  email TEXT,
  full_name TEXT NOT NULL,
  address TEXT NOT NULL,
  phone_number TEXT NOT NULL,
  agreed_to_rules_at TIMESTAMPTZ NOT NULL,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

-- Indexes
CREATE UNIQUE INDEX users_facebook_id_idx ON users(facebook_id);
CREATE INDEX users_created_at_idx ON users(created_at);
```

**TypeScript Type** (auto-generated by Supabase):
```typescript
export interface User {
  id: string;
  facebook_id: string;
  email: string | null;
  full_name: string;
  address: string;
  phone_number: string;
  agreed_to_rules_at: string;
  created_at: string;
  updated_at: string;
}
```

**Fields**:
- `id`: UUID, Primary Key, Auto-generated
- `facebook_id`: Text, Unique, Not Null - Facebook user ID from OAuth
- `email`: Text, Nullable - Email from Facebook (may not be provided)
- `full_name`: Text, Not Null - User's full name
- `address`: Text, Not Null - Street address within Abbington neighborhood
- `phone_number`: Text, Not Null - Mobile phone number (US format)
- `agreed_to_rules_at`: Timestamptz, Not Null - Timestamp when user agreed to tool share rules
- `created_at`: Timestamptz, Not Null, Default=now() - Account creation timestamp
- `updated_at`: Timestamptz, Not Null, Default=now() - Last profile update

**Validation Rules** (enforced in Next.js with Zod):
```typescript
import { z } from 'zod';

export const UserProfileSchema = z.object({
  full_name: z.string().min(1).max(255),
  address: z.string().min(1).max(1000),
  phone_number: z.string().regex(
    /^\+?1?\s*\(?\d{3}\)?[\s.-]?\d{3}[\s.-]?\d{4}$/,
    'Invalid US phone number format'
  ),
});
```

**Row Level Security (RLS)**:
```sql
-- Enable RLS
ALTER TABLE users ENABLE ROW LEVEL SECURITY;

-- Users can view all other users (needed to see tool owners)
CREATE POLICY "Users can view all users"
  ON users FOR SELECT
  USING (auth.role() = 'authenticated');

-- Users can update only their own profile
CREATE POLICY "Users can update own profile"
  ON users FOR UPDATE
  USING (auth.uid() = id);

-- Users can insert their own profile (on signup)
CREATE POLICY "Users can create own profile"
  ON users FOR INSERT
  WITH CHECK (auth.uid() = id);
```

**Business Rules**:
- Users cannot delete their account if they have tools listed (enforced in application)
- Email is optional (Facebook may not share it depending on user permissions)
- `updated_at` updated via trigger (see below)

---

### tools

Represents a physical tool available for sharing in the neighborhood.

**Schema** (Supabase table):
```sql
CREATE TABLE tools (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  owner_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  name TEXT NOT NULL,
  description TEXT,
  photo_url TEXT,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

-- Indexes
CREATE INDEX tools_owner_id_idx ON tools(owner_id);
CREATE INDEX tools_name_idx ON tools(name);

-- Full-text search index
CREATE INDEX tools_search_idx ON tools
  USING gin(to_tsvector('english', name || ' ' || COALESCE(description, '')));
```

**TypeScript Type**:
```typescript
export interface Tool {
  id: string;
  owner_id: string;
  name: string;
  description: string | null;
  photo_url: string | null;
  created_at: string;
  updated_at: string;
}

export interface ToolWithOwner extends Tool {
  owner: User;
}
```

**Fields**:
- `id`: UUID, Primary Key, Auto-generated
- `owner_id`: UUID, Foreign Key → users.id, Not Null, Cascade Delete
- `name`: Text, Not Null - Tool name (e.g., "Pressure Washer")
- `description`: Text, Nullable - Detailed description, condition notes
- `photo_url`: Text, Nullable - URL to photo in Supabase Storage
- `created_at`: Timestamptz, Not Null, Default=now() - When tool was added
- `updated_at`: Timestamptz, Not Null, Default=now() - Last edit timestamp

**Validation Rules** (Zod):
```typescript
export const ToolSchema = z.object({
  name: z.string().min(1).max(255),
  description: z.string().max(5000).optional(),
  photo: z.instanceof(File).optional(),
});
```

**Row Level Security (RLS)**:
```sql
-- Enable RLS
ALTER TABLE tools ENABLE ROW LEVEL SECURITY;

-- Anyone authenticated can view all tools
CREATE POLICY "Authenticated users can view all tools"
  ON tools FOR SELECT
  USING (auth.role() = 'authenticated');

-- Users can create their own tools
CREATE POLICY "Users can create own tools"
  ON tools FOR INSERT
  WITH CHECK (auth.uid() = owner_id);

-- Users can update only their own tools
CREATE POLICY "Users can update own tools"
  ON tools FOR UPDATE
  USING (auth.uid() = owner_id);

-- Users can delete only their own tools
CREATE POLICY "Users can delete own tools"
  ON tools FOR DELETE
  USING (auth.uid() = owner_id);
```

**Business Rules**:
- Users can only edit/delete tools they own (enforced by RLS)
- Deleting a tool should remove the photo from Supabase Storage (handled in application)
- Tool names are not required to be unique (multiple users can list "Ryobi Drill")

---

## Database Triggers

### Update `updated_at` timestamp automatically

```sql
-- Function to update updated_at column
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at = now();
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- Trigger for users table
CREATE TRIGGER update_users_updated_at
  BEFORE UPDATE ON users
  FOR EACH ROW
  EXECUTE FUNCTION update_updated_at_column();

-- Trigger for tools table
CREATE TRIGGER update_tools_updated_at
  BEFORE UPDATE ON tools
  FOR EACH ROW
  EXECUTE FUNCTION update_updated_at_column();
```

---

## Entity Relationship Diagram

```text
┌─────────────────────────────────────┐
│             users                    │
├─────────────────────────────────────┤
│ PK  id (UUID)                        │
│     facebook_id (unique)             │
│     email                            │
│     full_name                        │
│     address                          │
│     phone_number                     │
│     agreed_to_rules_at               │
│     created_at                       │
│     updated_at                       │
└──────────────┬──────────────────────┘
               │
               │ 1:N
               │ owns
               ▼
┌─────────────────────────────────────┐
│             tools                    │
├─────────────────────────────────────┤
│ PK  id (UUID)                        │
│ FK  owner_id → users.id (CASCADE)    │
│     name                             │
│     description                      │
│     photo_url                        │
│     created_at                       │
│     updated_at                       │
└─────────────────────────────────────┘
```

---

## Supabase Storage

### Bucket: `tools`

**Configuration**:
```typescript
// Create bucket (run once via Supabase dashboard or migration)
supabase.storage.createBucket('tools', {
  public: true,
  fileSizeLimit: 5242880, // 5MB
  allowedMimeTypes: ['image/jpeg', 'image/png', 'image/webp']
});
```

**Storage Policies**:
```sql
-- Allow authenticated users to upload
CREATE POLICY "Authenticated users can upload tool photos"
  ON storage.objects FOR INSERT
  WITH CHECK (
    bucket_id = 'tools'
    AND auth.role() = 'authenticated'
  );

-- Allow public read access (photos visible to all logged-in users)
CREATE POLICY "Public read access to tool photos"
  ON storage.objects FOR SELECT
  USING (bucket_id = 'tools');

-- Allow users to update their own photos
CREATE POLICY "Users can update own tool photos"
  ON storage.objects FOR UPDATE
  USING (
    bucket_id = 'tools'
    AND auth.uid()::text = (storage.foldername(name))[1]
  );

-- Allow users to delete their own photos
CREATE POLICY "Users can delete own tool photos"
  ON storage.objects FOR DELETE
  USING (
    bucket_id = 'tools'
    AND auth.uid()::text = (storage.foldername(name))[1]
  );
```

**File Naming Convention**:
`{user_id}/{tool_id}_{timestamp}.{ext}`

Example: `550e8400-e29b-41d4-a716-446655440000/7c9e6679-7425-40de-944b-e07fc1f90ae7_1698765432.jpg`

**Upload Flow** (Next.js Server Action):
```typescript
export async function uploadToolPhoto(
  userId: string,
  toolId: string,
  file: File
): Promise<string> {
  const timestamp = Date.now();
  const ext = file.name.split('.').pop();
  const fileName = `${userId}/${toolId}_${timestamp}.${ext}`;

  const { data, error } = await supabase.storage
    .from('tools')
    .upload(fileName, file, {
      cacheControl: '3600',
      upsert: false
    });

  if (error) throw error;

  // Get public URL
  const { data: { publicUrl } } = supabase.storage
    .from('tools')
    .getPublicUrl(fileName);

  return publicUrl;
}
```

---

## Search Implementation

### Full-Text Search Function

```sql
-- Function for full-text search
CREATE OR REPLACE FUNCTION search_tools(search_query TEXT)
RETURNS SETOF tools AS $$
BEGIN
  RETURN QUERY
  SELECT *
  FROM tools
  WHERE to_tsvector('english', name || ' ' || COALESCE(description, ''))
    @@ plainto_tsquery('english', search_query)
  ORDER BY
    ts_rank(
      to_tsvector('english', name || ' ' || COALESCE(description, '')),
      plainto_tsquery('english', search_query)
    ) DESC;
END;
$$ LANGUAGE plpgsql;
```

**Usage from Next.js**:
```typescript
// Search tools
const { data: tools } = await supabase
  .rpc('search_tools', { search_query: 'drill' });

// Or simple pattern matching (for small datasets)
const { data: tools } = await supabase
  .from('tools')
  .select('*, owner:users(*)')
  .or(`name.ilike.%${query}%,description.ilike.%${query}%`);
```

---

## Supabase Migrations

### Initial Schema (Migration 001)

Create file: `supabase/migrations/20251022000001_initial_schema.sql`

```sql
-- Create users table
CREATE TABLE users (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  facebook_id TEXT UNIQUE NOT NULL,
  email TEXT,
  full_name TEXT NOT NULL,
  address TEXT NOT NULL,
  phone_number TEXT NOT NULL,
  agreed_to_rules_at TIMESTAMPTZ NOT NULL,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

CREATE UNIQUE INDEX users_facebook_id_idx ON users(facebook_id);
CREATE INDEX users_created_at_idx ON users(created_at);

-- Create tools table
CREATE TABLE tools (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  owner_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  name TEXT NOT NULL,
  description TEXT,
  photo_url TEXT,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

CREATE INDEX tools_owner_id_idx ON tools(owner_id);
CREATE INDEX tools_name_idx ON tools(name);
CREATE INDEX tools_search_idx ON tools
  USING gin(to_tsvector('english', name || ' ' || COALESCE(description, '')));

-- Create update_updated_at function
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at = now();
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- Create triggers
CREATE TRIGGER update_users_updated_at
  BEFORE UPDATE ON users
  FOR EACH ROW
  EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_tools_updated_at
  BEFORE UPDATE ON tools
  FOR EACH ROW
  EXECUTE FUNCTION update_updated_at_column();

-- Enable RLS
ALTER TABLE users ENABLE ROW LEVEL SECURITY;
ALTER TABLE tools ENABLE ROW LEVEL SECURITY;

-- Users policies
CREATE POLICY "Users can view all users"
  ON users FOR SELECT
  USING (auth.role() = 'authenticated');

CREATE POLICY "Users can update own profile"
  ON users FOR UPDATE
  USING (auth.uid() = id);

CREATE POLICY "Users can create own profile"
  ON users FOR INSERT
  WITH CHECK (auth.uid() = id);

-- Tools policies
CREATE POLICY "Authenticated users can view all tools"
  ON tools FOR SELECT
  USING (auth.role() = 'authenticated');

CREATE POLICY "Users can create own tools"
  ON tools FOR INSERT
  WITH CHECK (auth.uid() = owner_id);

CREATE POLICY "Users can update own tools"
  ON tools FOR UPDATE
  USING (auth.uid() = owner_id);

CREATE POLICY "Users can delete own tools"
  ON tools FOR DELETE
  USING (auth.uid() = owner_id);

-- Search function
CREATE OR REPLACE FUNCTION search_tools(search_query TEXT)
RETURNS SETOF tools AS $$
BEGIN
  RETURN QUERY
  SELECT *
  FROM tools
  WHERE to_tsvector('english', name || ' ' || COALESCE(description, ''))
    @@ plainto_tsquery('english', search_query)
  ORDER BY
    ts_rank(
      to_tsvector('english', name || ' ' || COALESCE(description, '')),
      plainto_tsquery('english', search_query)
    ) DESC;
END;
$$ LANGUAGE plpgsql;
```

---

## TypeScript Integration

### Supabase Client Setup

```typescript
// lib/supabase/client.ts
import { createClientComponentClient } from '@supabase/auth-helpers-nextjs';
import { Database } from './database.types';

export const createClient = () => createClientComponentClient<Database>();
```

```typescript
// lib/supabase/server.ts
import { createServerComponentClient } from '@supabase/auth-helpers-nextjs';
import { cookies } from 'next/headers';
import { Database } from './database.types';

export const createServerClient = () =>
  createServerComponentClient<Database>({ cookies });
```

### Generate Types

```bash
# Generate TypeScript types from Supabase schema
npx supabase gen types typescript --project-id YOUR_PROJECT_ID > lib/supabase/database.types.ts
```

**Generated Types** (lib/supabase/database.types.ts):
```typescript
export type Json = string | number | boolean | null | { [key: string]: Json | undefined } | Json[]

export interface Database {
  public: {
    Tables: {
      users: {
        Row: {
          id: string
          facebook_id: string
          email: string | null
          full_name: string
          address: string
          phone_number: string
          agreed_to_rules_at: string
          created_at: string
          updated_at: string
        }
        Insert: {
          id?: string
          facebook_id: string
          email?: string | null
          full_name: string
          address: string
          phone_number: string
          agreed_to_rules_at: string
          created_at?: string
          updated_at?: string
        }
        Update: {
          id?: string
          facebook_id?: string
          email?: string | null
          full_name?: string
          address?: string
          phone_number?: string
          agreed_to_rules_at?: string
          created_at?: string
          updated_at?: string
        }
      }
      tools: {
        Row: {
          id: string
          owner_id: string
          name: string
          description: string | null
          photo_url: string | null
          created_at: string
          updated_at: string
        }
        Insert: {
          id?: string
          owner_id: string
          name: string
          description?: string | null
          photo_url?: string | null
          created_at?: string
          updated_at?: string
        }
        Update: {
          id?: string
          owner_id?: string
          name?: string
          description?: string | null
          photo_url?: string | null
          created_at?: string
          updated_at?: string
        }
      }
    }
    Functions: {
      search_tools: {
        Args: { search_query: string }
        Returns: Database['public']['Tables']['tools']['Row'][]
      }
    }
  }
}
```

---

## Sample Data (for Development)

```sql
-- Insert test users (use Supabase Auth for real users)
INSERT INTO users (id, facebook_id, full_name, address, phone_number, agreed_to_rules_at)
VALUES
  ('550e8400-e29b-41d4-a716-446655440000', 'fb_1234567890', 'John Smith', '123 Oak Street, Abbington', '(555) 123-4567', now()),
  ('7c9e6679-7425-40de-944b-e07fc1f90ae7', 'fb_9876543210', 'Jane Doe', '456 Maple Avenue, Abbington', '(555) 987-6543', now());

-- Insert test tools
INSERT INTO tools (owner_id, name, description)
VALUES
  ('550e8400-e29b-41d4-a716-446655440000', 'Pressure Washer', '2000 PSI, works great for driveways'),
  ('550e8400-e29b-41d4-a716-446655440000', 'Cordless Drill', 'Ryobi 18V with 2 batteries'),
  ('7c9e6679-7425-40de-944b-e07fc1f90ae7', 'Lawn Mower', 'Gas powered, self-propelled');
```

---

## Security Considerations

### Row Level Security (RLS)

**Enforced at database level** - even if application code has bugs, database policies prevent unauthorized access.

**Key Points**:
- All tables have RLS enabled
- Users can view all other users (needed to see tool owner contact info)
- Users can only modify their own data (profile, tools)
- Photo storage follows same user ownership pattern

### Authentication

Handled by Supabase Auth:
- Facebook OAuth provider
- JWT tokens (short-lived access tokens, refresh tokens)
- Automatic session management via auth helpers

### Input Validation

**Server-side validation** (Next.js Server Actions with Zod):
- Phone number format
- String length limits
- File upload restrictions (type, size)

**Client-side validation** (React Hook Form + Zod):
- Immediate feedback for better UX
- Same schema as server (shared validation)

---

## Future Enhancements (Not in Scope)

- Tool availability status column (available/borrowed/unavailable)
- Borrowing transactions table (request/approval/return tracking)
- Tool categories/tags (many-to-many relationship)
- Ratings/reviews table
- Admin roles (extend RLS policies)
- Soft delete with recovery period
- Tool reservation calendar (date ranges)
- Notification preferences table
